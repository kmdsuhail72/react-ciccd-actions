# name: Deploy Dist
# on: [push,workflow_dispatch]
# jobs:
#     test:
#         runs-on: ubuntu-latest
#         steps:
#             - name: Get Code
#               uses: actions/checkout@v6
#             - name : Install Node 22
#               uses: actions/setup-node@v6
#               with:
#                 node-version: 22
#             - name: print node version
#               run: node -v
#             - name: Install Dependencies
#               run: npm ci
#             - name: Run Tests
#               run : npm run test
            

#             #   run : |
#             #     echo "cloning repo"
#             #     echo "${{toJson(github)}}"
#             #     git clone https://github.com/${{github.repository}}.git
name: Deploy Dist

on:
  push:
    branches: [main, master]
    tags:
      - 'v*'
  pull_request:
    branches: [main, master]
  workflow_dispatch:  # Allows manual trigger

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Prevents hanging jobs
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4  # Updated to v4 (more stable)
        with:
          fetch-depth: 0  # Fetches all history for proper versioning
    
      - name: Setup Node.js
        uses: actions/setup-node@v4  # Updated to v4
        with:
          node-version: '22.x'
          cache: 'npm'  # Enables caching for faster builds
    
      - name: Verify Node.js Version
        run: |
          echo "Node version:"
          node --version
          echo "NPM version:"
          npm --version
    
      - name: Install Dependencies
        run: npm ci --prefer-offline  # Uses package-lock.json exactly
        env:
          NODE_ENV: development
    
      - name: Run Tests
        run: npm run test
        env:
          CI: true  # Sets test environment to CI mode
    
      - name: Upload Test Results (Optional)
        if: always()  # Runs even if tests fail
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            test-results/
            coverage/
          retention-days: 7
  
  build:
    name: Build and Deploy
    runs-on: ubuntu-latest
    needs: test  # Only runs if tests pass
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
    
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'
    
      - name: Install Dependencies
        run: npm ci
    
      - name: Build Project
        run: npm run build
        env:
          NODE_ENV: production
          REACT_APP_VERSION: ${{ github.sha }}
          REACT_APP_BUILD_DATE: ${{ github.event.head_commit.timestamp }}
    
      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 30
    
      # Add your deployment steps here based on your hosting platform
      # Example for GitHub Pages:
      # - name: Deploy to GitHub Pages
      #   uses: peaceiris/actions-gh-pages@v3
      #   with:
      #     github_token: ${{ secrets.GITHUB_TOKEN }}
      #     publish_dir: ./dist
    
      # Example for Firebase:
      # - name: Deploy to Firebase
      #   uses: w9jds/firebase-action@master
      #   with:
      #     args: deploy --only hosting
      #   env:
      #     FIREBASE_TOKEN: 